#!/bin/bash

# GPU Memory Reset Script for DeepStream Dual-Camera Pipeline
# Use this to clear GPU memory between pipeline runs if needed

echo "=========================================="
echo "DeepStream GPU Memory Reset Tool"
echo "=========================================="
echo ""

echo "üìä Current GPU Memory Status:"
if command -v tegrastats &> /dev/null; then
    echo "   Using tegrastats for Jetson:"
    timeout 2s tegrastats | head -1
else
    echo "‚ö†Ô∏è  tegrastats not available"
fi
echo ""

echo "üîç Checking for running DeepStream pipeline processes..."
PIPELINE_PIDS=$(pgrep -f "dual_cam_pipeline.py")
if [ -n "$PIPELINE_PIDS" ]; then
    echo "‚ö†Ô∏è  Found running pipeline processes:"
    ps aux | grep dual_cam_pipeline.py | grep -v grep
    echo ""
    read -p "Kill these processes? (y/n): " -n 1 -r
    echo ""
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo "üî´ Killing pipeline processes..."
        pkill -9 -f dual_cam_pipeline.py
        sleep 1
        echo "‚úÖ Processes killed"
    fi
else
    echo "‚úÖ No pipeline processes running"
fi
echo ""

echo "üîç Checking for stuck GStreamer/DeepStream processes..."
GSTREAMER_PIDS=$(pgrep -f "gst-launch\|nvstreammux\|nvinfer")
if [ -n "$GSTREAMER_PIDS" ]; then
    echo "‚ö†Ô∏è  Found GStreamer/DeepStream processes:"
    ps aux | grep -E "gst-launch|nvstreammux|nvinfer" | grep -v grep
    echo ""
    read -p "Kill these processes? (y/n): " -n 1 -r
    echo ""
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo "üî´ Killing GStreamer/DeepStream processes..."
        pkill -9 -f "gst-launch"
        pkill -9 -f "nvstreammux"
        pkill -9 -f "nvinfer"
        sleep 1
        echo "‚úÖ Processes killed"
    fi
else
    echo "‚úÖ No stuck GStreamer/DeepStream processes"
fi
echo ""

echo "üßπ Clearing Python cache and temporary files..."
find /tmp -name "*.pyc" -user $USER -delete 2>/dev/null
find /tmp -name "__pycache__" -user $USER -type d -exec rm -rf {} + 2>/dev/null
echo "‚úÖ Python cache cleared"
echo "" and CUDA cache clear..."
python3 << 'EOF'
import gc
import sys

# Force garbage collection
gc.collect()
print("‚úÖ Python GC completed")

# Clear CUDA cache if PyTorch available
try:
    import torch
    if torch.cuda.is_available():
        torch.cuda.empty_cache()
        torch.cuda.synchronize()
        print("‚úÖ PyTorch CUDA cache cleared")
    else:
        print("‚ÑπÔ∏è  CUDA not available via PyTorch")
except ImportError:
    print("‚ÑπÔ∏è  PyTorch not available")

# Clear TensorRT/CUDA resources (CSI camera daemon)..."
if pgrep -f nvargus-daemon > /dev/null; then
    NVARGUS_MEM=$(ps aux | grep nvargus-daemon | grep -v grep | awk '{print $6}')
    echo "‚úÖ nvargus-daemon is running (Memory: ${NVARGUS_MEM}KB)"
    echo ""
    read -p "Restart nvargus-daemon to free CSI camera resources? (y/n): " -n 1 -r
    echo ""
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo "üîÑ Restarting nvargus-daemon..."
        sudo systemctl restart nvargus-daemon
        sleep 2
        if pgrep -f nvargus-daemon > /dev/null; then
            echo "‚úÖ nvargus-daemon restarted successfully"
        else
            echo "‚ùå nvargus-daemon failed to restart"
        fi
    fi
else
    echo "‚ö†Ô∏è  nvargus-daemon is NOT running!"
    read -p "Start nvargus-daemon for CSI camera? (y/n): " -n 1 -r
    echo ""
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        sudo systemctl start nvargus-daemon
        sleep 2
        if pgrep -f nvargus-daemon > /dev/null; then
            echo "‚úÖ nvargus-daemon started successfully"
        else
            echo "‚ùå nvargus-daemon failed to start"
        fi
    fi
fi
echo ""

echo "üîç Checking camera devices..."
echo "   CSI Camera (/dev/video0):"
if [ -e /dev/video0 ]; then
    echo "   ‚úÖ Available"
    if command -v lsof &> /dev/null; then
        LOCKS=$(sudo lsof /dev/video0 2>/dev/null)
        if [ -z "$LOCKS" ]; then
            echo "      ‚úÖ Not locked by any process"
        else
            echo "      ‚ö†Ô∏è  Locked by:"
            echo "$LOCKS" | sed 's/^/      /'
        fi
    fi
else
    echo "   ‚ùå Not found"
fi

echo "   Thermal USB Camera (/dev/video1):"
if [ -e /dev/video1 ]; then
    echo "   ‚úÖ Available"
    if command -v v4l2-ctl &> /dev/null; then
        V4L2_INFO=$(v4l2-ctl --device=/dev/video1 --info 2>/dev/null | grep "Card type" | cut -d: -f2)
        echo "      Device:$V4L2_INFO"
    fi
    if command -v lsof &> /dev/null; then
        LOCKS=$(sudo lsof /dev/video1 2>/dev/null)
        if [ -z "$LOCKS" ]; then
            echo "      ‚úÖ Not locked by any process"
        else
            echo "      ‚ö†Ô∏è  Locked by:"
            echo "$LOCKS" | sed 's/^/      /'
        fi
    fi
else
    echo "   ‚ùå Not found>/dev/null | head -10
        echo ""
        read -p "Unexport GPIO pins 32 and 33? (y/n): " -n 1 -r
        echo ""
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            echo "üîå Unexporting GPIO pins..."
            echo 32 | sudo tee /sys/class/gpio/unexport 2>/dev/null && echo "‚úÖ GPIO 32 unexported" || echo "‚ÑπÔ∏è  GPIO 32 not exported"
            echo 33 | sudo tee /sys/class/gpio/unexport 2>/dev/null && echo "‚úÖ GPIO 33 unexported" || echo "‚ÑπÔ∏è  GPIO 33 not exported"
        fi
    else
        echo "‚úÖ No GPIO pins exported"
    fitegrastats &> /dev/null; then
    echo "   Using tegrastats:"
    timeout 2s tegrastats | head -1
else
    echo "   ‚ÑπÔ∏è  tegrastats not available"
fi
echo ""

echo "2. Camera Devices:"
if [ -e /dev/video0 ]; then
    echo "   ‚úÖ CSI /dev/video0 available"
    if command -v lsof &> /dev/null; then
        LOCKS=$(sudo lsof /dev/video0 2>/dev/null)
        if [ -z "$LOCKS" ]; then
            echo "      ‚úÖ Not locked"
        else
            echo "      ‚ö†Ô∏è  Locked by process"
        fi
    fi
else
    echo "   ‚ùå CSI /dev/video0 not found"
fi

if [ -e /dev/video1 ]; then
    echo "   ‚úÖ USB /dev/video1 available"
    if command -v lsof &> /dev/null; then
        LOCKS=$(sudo lsof /dev/video1 2>/dev/null)
        if [ -z "$LOCKS" ]; then
            echo "      ‚úÖ Not locked"
        else
            echo "      ‚ö†Ô∏è  Locked by process"
        fi
    fi
elseDeepStream/Python Processes:"
if pgrep -f "dual_cam_pipeline.py\|nvstreammux\|nvinfer" > /dev/null; then
    echo "   ‚ö†Ô∏è  Processes still running:"
    ps aux | grep -E "dual_cam_pipeline.py|nvstreammux|nvinfer" | grep -v grep
else
    echo "   ‚úÖ No processes running"
fi
echo ""

echo "=========================================="
echo "‚úÖ GPU Memory Reset Complete!"
echo "=========================================="
echo ""
echo "üí° You can now run the dual-camera pipeline:"
echo "   cd /home/jet-nx8/DeepStream-Yolo"
echo "   python3 dual_cam_pipeline.py"
echo ""
echo "üìã TensorRT Engine Files:"
if [ -f "/home/jet-nx8/DeepStream-Yolo/model_b8_gpu0_fp16.engine" ]; then
    ENGINE_SIZE=$(ls -lh /home/jet-nx8/DeepStream-Yolo/model_b8_gpu0_fp16.engine | awk '{print $5}')
    echo "   ‚úÖ Daylight: model_b8_gpu0_fp16.engine ($ENGINE_SIZE)"
else
    echo "   ‚ö†Ô∏è  Daylight engine not found"
fi
if [ -f "/home/jet-nx8/DeepStream-Yolo/model_thermal_b1_gpu0_fp16.engine" ]; then
    ENGINE_SIZE=$(ls -lh /home/jet-nx8/DeepStream-Yolo/model_thermal_b1_gpu0_fp16.engine | awk '{print $5}')
    echo "   ‚úÖ Thermal: model_thermal_b1_gpu0_fp16.engine ($ENGINE_SIZE)"
else
    echo "   ‚ö†Ô∏è  Thermal engine not found"
fi
    echo "   ‚ùå /dev/video0 not found"
fi
echo ""

echo "3. nvargus-daemon:"
if pgrep -f nvargus-daemon > /dev/null; then
    echo "   ‚úÖ Running"
    ps aux | grep nvargus-daemon | grep -v grep | awk '{print "   Memory:", $6/1024, "MB"}'
else
    echo "   ‚ùå Not running"
fi
echo ""

echo "4. Python/GStreamer Processes:"
if pgrep -f "gstreamer_yolo_tracker.py\|gstreamer" > /dev/null; then
    echo "   ‚ö†Ô∏è  Processes still running:"
    ps aux | grep -E "gstreamer_yolo_tracker.py|gstreamer" | grep -v grep
else
    echo "   ‚úÖ No processes running"
fi
echo ""

echo "=========================================="
echo "‚úÖ GPU Memory Reset Complete!"
echo "=========================================="
echo ""
echo "üí° You can now run the tracker again:"
echo "   /home/jet-nx8/Sandbox/ultralytics-env/bin/python3.10 gstreamer_yolo_tracker.py \\"
echo "       --source camera --enable-gimbal --enable-tracker \\"
echo "       --enable-inset-window --enable-tiling --disable-sound"
echo ""
